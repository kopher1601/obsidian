OAuth2 프레임워크는 **권한 부여 서버**와 **리소스 서버**라는 두 가지 별도의 엔티티를 정의한다. 권한 부여 서버의 목적은 사용자에게 권한을 부여하고 사용자의 이용 권리 집합을 지정하는 토큰을 제공하는 것이다. 이 기능을 구현하는 백엔드 부분을 리소스 서버라고 하며 호출할 수 있는 엔드포인트는 **보호된 리소스**로 볼 수 있다. 권한 부여를 수행한 후 획득한 토큰에 따라 리소스에 대한 호출이 허용되거나 거부된다. 

OAuth2 를 **권한 부여 프레임워크**라고 부르는 경우가 많으며, 타사 웹사이트나 웹이 리소스에 접근할 수 있게 허용하는 것이 주 목적이다.

OAuth2 를 이용한다는 것은 권한 부여에 **토큰**을 이용한다는 뜻이다. 토큰은 액세스 카드와 비슷하다고 했었다. 토큰을 얻은 후에는 특정 리소스에 접근할 수 있다. OAuth2 는 `Grant` 라고 하는 토큰을 얻는 여러 방법을 제공한다.

## OAuth2 구성요소
- **Resource Server** : 사용자가 소유한 리소스를 호스팅하는 서버, 리소스는 사용자의 데이터이거나 사용자가 수행할 수 있는 작업일 수 있다
- **Resource Owner** : 리소스 서버가 노출하는 리소스를 소유하는 개인, 일반적으로 사용자는 사용자 이름과 암호로 신원을 증명한다
- **Client** : 사용자를 대신해 사용자가 소유한 리소스에 접근하는 애플리케이션. 클라이언트는 클라이언트 Id 와 클라이언트 secret 을 이용해 신원을 증명한다. 이러한 자격증명은 사용자 자격 증명과는 다르다. 클라이언트는 요청할 때 자신을 증명하는 자체 자격 증명이 필요하다
- **Authorization Server** : 클라이언트가 리소스 서버가 노출하는 사용자의 리소스에 접근할 권한을 부여하는 애플리케이션. Authorization Server(권한 부여 서버)는 클라이언트가 사용자 대신 리소스에 접근 권한이 있다고 결정하면 **토큰을 발급**한다. 클라이언트는 이 토큰을 이용해 권한 부여 서버에서 권한을 받았음을 **리소스 서버에 증명**한다. 리소스 서버는 **유효한 토큰이 있으면 클라이언트가 요청한 리소스에 접근하게 허용**한다
![[IMG_0944.jpg]]
## OAuth2 Grant Type
### **Authorization Code Grant :**
- 사용자가 외부 인증 서버(예: Google, GitHub)로 리디렉션되어 로그인하고 접근 권한을 부여합니다
- 인증 서버는 '인증 코드'를 클라이언트로 전달하고, 클라이언트는 이 코드를 액세스 토큰과 교환합니다
> **코드**는 사용자가 리소스에 접근할 수 있도록 사용자가 인증했다는 클라이언트의 증명이다.
- 웹 서버 애플리케이션에 가장 적합한 방식입니다
- **주요한 프로퍼티들**
	- `response_type` : 클라이언트가 코드를 기대한다는 것을 권한 부여 서버에 알리는 값인 `code` 를 포함한다. 클라이언트가 `access_token` 을 얻으려면 `code` 가 필요하다
	- `client_id` : 애플리케이션 자체를 식별하는 클라이언트 id 값
	- `redirect_uri` : 인증 성공 후 사용자를 리디렉션할 위치를 권한 부여 서버에 알려준다
	- `scope` : 허가된 권한 같은것
	- `state` : [[CSRF]] 보호를 위한 `CSRF` 토큰을 정의한다
![[IMG_0945.jpg]]

### **Implicit Grant :**
- 사용자가 로그인하면 액세스 토큰이 직접 클라이언트로 반환됩니다
- 주로 브라우저 기반 애플리케이션에 사용되며, 인증 코드를 사용하지 않는 대신 보안상 주의가 필요합니다

### **Resource Owner Password Credentials Grant :**
- 사용자가 클라이언트 애플리케이션에 직접 사용자 이름과 비밀번호를 입력합니다.
- 클라이언트가 사용자 자격 증명을 직접 받고 이를 사용하여 액세스 토큰을 요청합니다.
- 클라이언트와 사용자 간의 신뢰가 높은 경우에만 사용해야 합니다.

### **Client Credentials Grant :**
- 사용자가 개입하지 않고 클라이언트 자체가 자체적인 자격 증명(Client ID, Client Secret 등)을 사용하여 액세스 토큰을 얻습니다.
- 애플리케이션과 서비스 간에 신뢰가 있는 경우에 사용됩니다

## OAuth2 의 허점
- **클라이언트에서 CSRF 이용** : 애플리케이션이 CSRF 보호 메커니즘을 적용하지 않으면 사용자가 로그인 했을 때 CSRF 가 가능하다.
- **클라이언트 자격 증명 도용** : 보호되지 않은 자격 증명을 저장하거나 전송하면 이를 공격자가 도용하는 위반이 발생할 수 있다.
- **토큰 재생** : 토큰을 네트워크를 통해 보내는 동안 누군가 가로챌 수 있다. 이렇게 도난당한 토큰은 재사용될 수 있다.
- **토큰 하이재킹** : 위의 예와 같이 토큰을 가로채는것을 말한다.





